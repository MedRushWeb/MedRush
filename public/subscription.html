<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choose Your Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body { background: linear-gradient(to right, #f8fafc, #e0f2fe); color: #1e293b; }
    .navbar { background: #1d4ed8; color: white; padding: 16px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
    .navbar h2 { font-size: 24px; }
    .nav-links a { color: white; margin-left: 20px; text-decoration: none; font-weight: 500; }
    .nav-links a:hover { text-decoration: underline; }
    .container { max-width: 1200px; margin: 0px auto; padding: 10px; text-align: center; }
    .container h1 { font-size: 36px; margin-bottom: 40px; color: #0f172a; }
    .plans { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
    .plan-card { background: white; border-radius: 16px; padding: 30px; width: 270px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); transition: transform 0.4s ease, border 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
    .plan-card::before { content: ''; position: absolute; height: 100%; width: 6px; background: #3b82f6; left: 0; top: 0; transition: width 0.3s; }
    .plan-card.selected::before { width: 100%; background: linear-gradient(90deg, #2563eb, #3b82f6); z-index: -1; }
    .plan-card.selected { color: white; transform: scale(1.05); }
    .plan-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
    .plan-price { font-size: 20px; margin-bottom: 15px; color: #2563eb; }
    .plan-card.selected .plan-price, .plan-card.selected .plan-title { color: white; }
    .plan-features { list-style: none; margin-bottom: 20px; }
    .plan-features li { margin: 8px 0; }
    .highlight { border: 3px solid #f59e0b; background: linear-gradient(145deg, #fff7ed, #fffbeb); min-height: 520px; position: relative; z-index: 5; box-shadow: 0 12px 24px rgba(0,0,0,0.25); }
    .footer { margin-top: 0px; text-align: center; padding: 20px; background: #1e40af; color: white; }
    @media (max-width: 900px) { .plans { flex-direction: column; align-items: center; } }
    .highlight-wrapper { display: flex; flex-direction: column; align-items: center; margin-top: -80px; }
    .highlight-label { background: #f59e0b; color: white; font-weight: bold; padding: 6px 12px; border-radius: 999px; font-size: 20px; margin-bottom: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 999; }
  
  .plan-card-free-plan {background: white; border-radius: 16px; padding: 30px; width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); transition: transform 0.4s ease, border 0.3s ease; position: relative; overflow: hidden; cursor: pointer;}
   
  
  .free-btn {
    background-color: #007bff;       /* Bootstrap blue */
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 15px;
  }

  .free-btn:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
  }

  .free-btn:active {
    background-color: #004080;
    transform: translateY(0);
  }







   #LEMONSQUEEZY-HREF_1m {
    width:100%;
    background-color: #6e59f2; /* LemonSqueezy purple */
    color: white;
    font-weight: 600;
    font-size: 16px;
    padding: 6px 8px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(110, 89, 242, 0.3);
  }

  #LEMONSQUEEZY-HREF_1m:hover {
    background-color: #5b4ad1;
    box-shadow: 0 6px 16px rgba(110, 89, 242, 0.4);
    transform: translateY(-1px);
  }

  #LEMONSQUEEZY-HREF_1m:active {
    transform: translateY(1px);
    box-shadow: 0 3px 8px rgba(110, 89, 242, 0.3);
  }


  

     #LEMONSQUEEZY-HREF_6m {
    width:100%;
    background-color: #6e59f2; /* LemonSqueezy purple */
    color: white;
    font-weight: 600;
    font-size: 16px;
    padding: 6px 8px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(110, 89, 242, 0.3);
  }

  #LEMONSQUEEZY-HREF_6m:hover {
    background-color: #5b4ad1;
    box-shadow: 0 6px 16px rgba(110, 89, 242, 0.4);
    transform: translateY(-1px);
  }

  #LEMONSQUEEZY-HREF_6m:active {
    transform: translateY(1px);
    box-shadow: 0 3px 8px rgba(110, 89, 242, 0.3);
  }



     #LEMONSQUEEZY-HREF_1y {
    width:100%;
    background-color: #6e59f2; /* LemonSqueezy purple */
    color: white;
    font-weight: 600;
    font-size: 16px;
    padding: 6px 8px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(110, 89, 242, 0.3);
  }

  #LEMONSQUEEZY-HREF_1y:hover {
    background-color: #5b4ad1;
    box-shadow: 0 6px 16px rgba(110, 89, 242, 0.4);
    transform: translateY(-1px);
  }

  #LEMONSQUEEZY-HREF_1y:active {
    transform: translateY(1px);
    box-shadow: 0 3px 8px rgba(110, 89, 242, 0.3);
  }



  </style>


<script src="https://www.paypal.com/sdk/js?client-id=AXXKx4gEyEMIENeXINnEn5TOVJ76t5Gu11vqlN-rfwn7kr6kMLErz_JjJT9G64rBuRJQDT0o0r1mtSyF&vault=true&intent=subscription"></script>



</head>
<body>

  <div class="navbar">
    <h2>DrWheezy</h2>
    <div class="nav-links">
      <a href="home.html">Home</a>
      <a href="#">Features</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>

<!-- Subscription status display -->
  <div id="subscription-status" style="margin-bottom: 20px; text-align: left; font-size: 18px;">
    <p>Your subscription is: <span id="sub-status" style="font-weight: bold;"></span></p>
    <p>Ends in: <span id="sub-end-date" style="font-weight: bold;">--</span></p>
  </div>

    <h1></h1>
    <div class="plans">


      <!-- Free Plan -->
<div class="plan-card-free-plan" onclick="selectPlan(this)">
  <div class="plan-title">Free Plan</div>
  <div class="plan-price">0$/month</div>
  <ul class="plan-features">
    <li>‚úî 4 exams only</li>
    <li>‚úò no reset option</li>
    <li>‚úò No customized exams per id </li>
    <li>‚úò No performance tracking</li>
  </ul>
  <button class="free-btn" onclick="activateFreePlan()"> Free plan</button>
</div>

      <!-- 1 Month -->
      <div class="plan-card" onclick="selectPlan(this)">
        <div class="plan-title">1 month</div>
        <div class="plan-price">20$/month</div>
        <ul class="plan-features">
          <li>‚úî 1 month only</li>
          <li>‚úî all questions accessible</li>
          <li>‚úî custom id questions accessible</li>
          <li>‚úî unlimited exams</li>
        </ul>
        <div id="paypal-button-container-1m"></div>
        <button id="LEMONSQUEEZY-HREF_1m">Pay Lemon Squeezy</button>
      </div>



      <!-- Highlighted Plan -->
      <div class="highlight-wrapper">
        <div class="highlight-label">Our Most Subscribed Plan</div>
        <div class="plan-card highlight" onclick="selectPlan(this)">
          <div class="plan-title">1 year</div>
          <div class="plan-price">10$/month</div>
          <div class="plan-price">120$/year</div>
          <ul class="plan-features">
            <li>‚úî 1 year</li>
            <li>‚úî all questions accessible</li>
            <li>‚úî custom id questions accessible</li>
            <li>‚úî unlimited exams</li>
          </ul>
          <div id="paypal-button-container-1y"></div>
          <button id="LEMONSQUEEZY-HREF_1y">Pay Lemon Squeezy</button>

        </div>
      </div>

      <!-- 6 Months -->
      <div class="plan-card" onclick="selectPlan(this)">
        <div class="plan-title">6 months</div>
        <div class="plan-price">15$/month</div>
        <div class="plan-price">90$/6 months</div>
        <ul class="plan-features">
          <li>‚úî 6 months</li>
          <li>‚úî all questions accessible</li>
          <li>‚úî custom id questions accessible</li>
          <li>‚úî unlimited exams</li>
        </ul>
        <div id="paypal-button-container-6m"></div>
        <button id="LEMONSQUEEZY-HREF_6m">Pay Lemon Squeezy</button>

      </div>

    </div>
  </div>

  <div class="footer">&copy; 2025 DrWheezy.</div>




<script type="module">
// alert(localStorage.getItem("email"));


/*
  // UI 
  function selectPlan(card) {
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
  }
  window.selectPlan = selectPlan;

  // ID & Flags 
  const uid = localStorage.getItem("uid"); // keep UID from LocalStorage

  // Firebase Init 
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

  let _db;
  async function initFirebase() {
    if (_db) return _db;
    const res = await fetch("/firebase-config");
    const config = await res.json();
    const app = initializeApp(config);
    _db = getFirestore(app);
    return _db;
  }

  // subscriptionID (Firestore ONLY) 
 // async function saveSubscriptionID(uid, subscriptionID) {
 //   try {
 //     const db = await initFirebase();
 //     await setDoc(
 //       doc(db, "userSubscriptions", uid),
 //       { subscriptionID, updatedAt: serverTimestamp() },
 //       { merge: true }
 //     );
 //     console.log("‚úÖ subscriptionID saved to Firestore");
 //   } catch (e) {
 //     console.error("‚ùå Firestore save failed:", e);
 //   }
//  }






// subscriptionID (Firestore ONLY, per provider) 
// provider: "paypal" | "lemonsqueezy"
async function saveSubscriptionID(uid, subscriptionID, provider) {
  try {
    if (!uid) throw new Error("Missing uid");
    if (!subscriptionID) throw new Error("Missing subscriptionID");
    if (!["paypal", "lemonsqueezy"].includes(provider)) {
      throw new Error(`Invalid provider: ${provider}`);
    }

    const db = await initFirebase(); // if your initFirebase returns { firestore }, use: const { firestore: db } = await initFirebase();

    // Pick field name by provider
    const fieldName = provider === "paypal" ? "PPsubscriptionID" : "LSsubscriptionID";

    await setDoc(
      doc(db, "userSubscriptions", uid),
      { [fieldName]: subscriptionID, updatedAt: serverTimestamp() },
      { merge: true }
    );

    console.log(`‚úÖ ${fieldName} saved to Firestore: ${subscriptionID}`);
  } catch (e) {
    console.error("‚ùå Firestore save failed:", e);
  }
}





//  async function loadSubscriptionID(uid) {
//    try {
//      const db = await initFirebase();
//      const snap = await getDoc(doc(db, "userSubscriptions", uid));
//      if (snap.exists()) {
//        const id = snap.data()?.subscriptionID;
//        if (id) {
//          console.log("üì• subscriptionID loaded from Firestore:", id);
//          return id;
//        }
//      }
//    } catch (e) {
//      console.error("‚ùå Firestore load failed:", e);
//    }
//    return null;
//  }





// provider: "paypal" | "lemonsqueezy"
async function loadSubscriptionID(uid, provider) {
  try {
    if (!uid) throw new Error("Missing uid");
    if (!["paypal", "lemonsqueezy"].includes(provider)) {
      throw new Error(`Invalid provider: ${provider}`);
    }
    // If your initFirebase returns { firestore, storage }, destructure:
    // const { firestore: db } = await initFirebase();
    const db = await initFirebase();
    const snap = await getDoc(doc(db, "userSubscriptions", uid));
    if (!snap.exists()) {
      console.log(`‚ö†Ô∏è No subscription doc for uid: ${uid}`);
      return null;
    }
    const fieldName = provider === "paypal" ? "PPsubscriptionID" : "LSsubscriptionID";
    const id = snap.data()?.[fieldName] || null;
    if (id) {
      console.log(`üì• ${fieldName} loaded from Firestore:`, id);
      return id;
    }
    // (Optional) legacy fallback if you used a single 'subscriptionID' before
    const legacy = snap.data()?.subscriptionID;
    if (legacy) {
      console.log("üîé Legacy subscriptionID found (consider migrating):", legacy);
      return legacy;
    }
    return null;
  } catch (e) {
    console.error("‚ùå Firestore load failed:", e);
    return null;
  }
}

















  // PayPal: Check status (server endpoint: /check-subscription) 
  async function checkSubscription() {
    if (!uid) {
      console.log("‚ùå No user ID found");
      alert("No user ID found. Please log in.");
      return;
    }

   // const subscriptionID = await loadSubscriptionID(uid);

    const subscriptionID = await loadSubscriptionID(uid, "paypal");


     




    if (!subscriptionID) {
      console.log("‚ùå No subscription found for this user");
      alert("No subscription found for this user.");
      return;
    }

    fetch(`/check-subscription?subscriptionID=${subscriptionID}`)
      .then(res => res.json())
      .then(data => {
        console.log("PayPal subscription status:", data.status);
        if (data.status === "ACTIVE") {
          localStorage.setItem(`isSubscribed_${uid}`, "true");
          alert("‚úÖ PayPal subscription is active");
        } else {
          localStorage.setItem(`isSubscribed_${uid}`, "false");
          alert("‚ùå PayPal subscription is not active");
        }
      })
      .catch(err => {
        console.error("PayPal check error:", err);
        alert("Error checking PayPal subscription.");
      });
  }

  // PayPal Buttons 
  function renderPayPalButton(selector, planId) {
    if (typeof paypal === "undefined" || !paypal?.Buttons) {
      console.warn("‚ö†Ô∏è PayPal SDK not loaded; skipping render for", selector);
      return;
    }
    paypal.Buttons({
      createSubscription: function (data, actions) {
        return actions.subscription.create({ plan_id: planId });
      },
      onApprove: async function (data) {
        if (!uid) {
          alert("‚ùå Cannot save subscription ‚Äî no user ID.");
          return;
        }
        const subId = data.subscriptionID;
        console.log("Approved (PayPal), subscriptionID:", subId);
       // await saveSubscriptionID(uid, subId);


        await saveSubscriptionID(uid, subId, "paypal");




        checkSubscription();
      }
    }).render(selector);
  }

  // TODO: put your real sandbox plan IDs here (or keep one if all the same)
  renderPayPalButton('#paypal-button-container-1m', 'P-2MW634431J448221NNCJ7F5I');
  renderPayPalButton('#paypal-button-container-1y', 'P-2MW634431J448221NNCJ7F5I');
  renderPayPalButton('#paypal-button-container-6m', 'P-2MW634431J448221NNCJ7F5I');


  // Lemon Squeezy Safe Loader 
  async function loadLemonScript() {
    if (window.LemonSqueezy) return window.LemonSqueezy;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://app.lemonsqueezy.com/js/lemon.js';
      s.async = true;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
    // wait for global
    return new Promise((resolve, reject) => {
      let tries = 0;
      const iv = setInterval(() => {
        if (window.LemonSqueezy) { clearInterval(iv); resolve(window.LemonSqueezy); }
        if (++tries > 50) { clearInterval(iv); reject(new Error("LemonSqueezy failed to load")); }
      }, 100);
    });
  }
  async function ensureLemon() { return window.LemonSqueezy || await loadLemonScript(); }

  // Lemon Squeezy Checkout URLs (replace with your real ones) 
  const LS_CHECKOUT_1M = "https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1";
  const LS_CHECKOUT_1Y = "https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1";
  const LS_CHECKOUT_6M = "https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1";



  async function openLsCheckout(url) {
    const LS = await ensureLemon();
    LS.Open({ checkout: url });
  }

  // Resolve by order_id (server: /ls/resolve-subscription), save, then check
  async function finalizeLsSubscription(orderId) {
    if (!orderId) return;
    if (!uid) { alert("‚ùå Cannot save subscription ‚Äî no user ID."); return; }
    try {
      const res = await fetch(`/ls/resolve-subscription?order_id=${orderId}`);
      const json = await res.json();
      const subscriptionID = json.subscriptionID;
      if (!subscriptionID) {
        console.error("No subscriptionID returned from server", json);
        alert("Could not resolve subscription. Contact support.");
        return;
      }
      console.log("Resolved (LS) subscriptionID:", subscriptionID);
  //    await saveSubscriptionID(uid, subscriptionID);


await saveSubscriptionID(uid, subscriptionID, "lemonsqueezy");



      await checkSubscriptionLS(subscriptionID);
    } catch (e) {
      console.error("Finalize LS error:", e);
      alert("Error finalizing Lemon Squeezy subscription.");
    }
  }

  // Check LS status (server: /check-ls-subscription)
  async function checkSubscriptionLS(subscriptionIDFromEvent) {
    try {
   //   const subscriptionID = subscriptionIDFromEvent || await loadSubscriptionID(uid);

      const subscriptionID = subscriptionIDFromEvent || await loadSubscriptionID(uid, "lemonsqueezy");

   



      if (!subscriptionID) {
        console.log("‚ùå No LS subscription found for this user");
        alert("No LS subscription found for this user.");
        return;
      }
      const r = await fetch(`/check-ls-subscription?subscriptionID=${subscriptionID}`);
      const data = await r.json();
      const status = (data && data.status) || "unknown";
      console.log("LS subscription status:", status);

      if (status === "active") {
        localStorage.setItem(`isSubscribed_${uid}`, "true");
        alert("‚úÖ Lemon Squeezy subscription is active");
      } else {
        localStorage.setItem(`isSubscribed_${uid}`, "false");
        alert(`‚ùå Lemon Squeezy subscription not active (status: ${status})`);
      }
    } catch (e) {
      console.error("LS check error:", e);
      alert("Error checking Lemon Squeezy subscription.");
    }
  }











  // Setup LS success handler (equivalent to PayPal onApprove)
//  (async () => {
//    try {
//      const LS = await ensureLemon();

//LSLemonSqueezy.Setup({
//  eventHandler: (e) => {
//    if (e.event === 'Checkout.Success') {
//      console.log('‚úÖ Full LS event:', e); // inspect structure in your console
//      const orderId = e?.data?.id;          // <-- string like "12345"
//      console.log('LS Checkout.Success, order_id:', orderId);
//      finalizeLsSubscription(orderId);
//    }
//  }
//});

 //   } catch (e) {
 //     console.warn("LS not initialized (loader error). If you don't use LS, ignore this.");
 //   }
 // })();



// ‚úÖ correct object + correct path to order id
(async () => {
  try {
    const LS = await ensureLemon();

    LS.Setup({
      eventHandler: async (e) => {
        if (e?.event === "Checkout.Success") {
          console.log("‚úÖ Full LS event:", e);
      //    const orderId = e?.data?.order?.data?.id;   // ‚Üê this is your "6145554"
          const orderId = e?.data?.id || e?.data?.order?.data?.id; // fallback to your shape

          console.log("LS Checkout.Success, order_id:", orderId);

          if (!orderId) {
            console.error("‚ö†Ô∏è Couldn‚Äôt read orderId from event payload");
            return;
          }
          await finalizeLsSubscription(orderId);       // your backend: resolve by order_id ‚Üí subscriptionID
        }
      }
    });
  } catch (e) {
    console.warn("LS not initialized (loader error).", e);
  }
})();




















  // Attach LS buttons (ensure these IDs exist in your HTML)
  const btn1m = document.getElementById("ls-subscribe-1m");
  const btn1y = document.getElementById("ls-subscribe-1y");
  const btn6m = document.getElementById("ls-subscribe-6m");
  if (btn1m) btn1m.addEventListener('click', () => openLsCheckout(LS_CHECKOUT_1M));
  if (btn1y) btn1y.addEventListener('click', () => openLsCheckout(LS_CHECKOUT_1Y));
  if (btn6m) btn6m.addEventListener('click', () => openLsCheckout(LS_CHECKOUT_6M));

  // On load 
  window.onload = () => {
    if (!uid) return;
    // Call whichever provider(s) you want to verify on load:
    // checkSubscription();     // PayPal status
    // checkSubscriptionLS();   // Lemon Squeezy status
  };

  // Free plan 
  function activateFreePlan() { window.location.href = "connect.html"; }
  window.activateFreePlan = activateFreePlan;





























































*/


  /*
  
  // UI 
    function selectPlan(card) {
      document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      // Optional: remember selection
    }
    window.selectPlan = selectPlan;

    // ID & Flags
    const uid = localStorage.getItem("uid") || "demo-user"; // keep UID from LocalStorage (fallback demo)

    // Firebase Init 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

    let _db;
    async function initFirebase() {
      if (_db) return _db;
      const res = await fetch("/firebase-config");
      const config = await res.json();
      const app = initializeApp(config);
      _db = getFirestore(app);
      return _db;
    }

    // subscriptionID (Firestore ONLY, per provider)
    // provider: "paypal" | "lemonsqueezy"
    async function saveSubscriptionID(uid, subscriptionID, provider) {
      try {
        if (!uid) throw new Error("Missing uid");
        if (!subscriptionID) throw new Error("Missing subscriptionID");
        if (!["paypal", "lemonsqueezy"].includes(provider)) {
          throw new Error(`Invalid provider: ${provider}`);
        }
        const db = await initFirebase();
        const fieldName = provider === "paypal" ? "PPsubscriptionID" : "LSsubscriptionID";
        await setDoc(
          doc(db, "userSubscriptions", uid),
          { [fieldName]: subscriptionID, updatedAt: serverTimestamp() },
          { merge: true }
        );
        console.log(`‚úÖ ${fieldName} saved to Firestore: ${subscriptionID}`);
      } catch (e) {
        console.error("‚ùå Firestore save failed:", e);
      }
    }

    // provider: "paypal" | "lemonsqueezy"
    async function loadSubscriptionID(uid, provider) {
      try {
        if (!uid) throw new Error("Missing uid");
        if (!["paypal", "lemonsqueezy"].includes(provider)) {
          throw new Error(`Invalid provider: ${provider}`);
        }
        const db = await initFirebase();
        const snap = await getDoc(doc(db, "userSubscriptions", uid));
        if (!snap.exists()) {
          console.log(`‚ö†Ô∏è No subscription doc for uid: ${uid}`);
          return null;
        }
        const fieldName = provider === "paypal" ? "PPsubscriptionID" : "LSsubscriptionID";
        const id = snap.data()?.[fieldName] || null;
        if (id) {
          console.log(`üì• ${fieldName} loaded from Firestore:`, id);
          return id;
        }
        const legacy = snap.data()?.subscriptionID;
        if (legacy) {
          console.log("üîé Legacy subscriptionID found (consider migrating):", legacy);
          return legacy;
        }
        return null;
      } catch (e) {
        console.error("‚ùå Firestore load failed:", e);
        return null;
      }
    }

    // PayPal: Check status (server endpoint: /check-subscription) 
    async function checkSubscription() {
      if (!uid) {
        console.log("‚ùå No user ID found");
        alert("No user ID found. Please log in.");
        return;
      }

      const subscriptionID = await loadSubscriptionID(uid, "paypal");
      if (!subscriptionID) {
        console.log("‚ùå No subscription found for this user");
        alert("No subscription found for this user.");
        return;
      }

      fetch(`/check-subscription?subscriptionID=${encodeURIComponent(subscriptionID)}`)
        .then(res => res.json())
        .then(data => {
          console.log("PayPal subscription status:", data.status);
          if (data.status === "ACTIVE") {
            localStorage.setItem(`isSubscribed_${uid}`, "true");
            alert("‚úÖ PayPal subscription is active");
          } else {
            localStorage.setItem(`isSubscribed_${uid}`, "false");
            alert("‚ùå PayPal subscription is not active");
          }
        })
        .catch(err => {
          console.error("PayPal check error:", err);
          alert("Error checking PayPal subscription.");
        });
    }
    window.checkSubscription = checkSubscription;

    // PayPal Buttons
    function renderPayPalButton(selector, planId) {
      if (typeof paypal === "undefined" || !paypal?.Buttons) {
        console.warn("‚ö†Ô∏è PayPal SDK not loaded; skipping render for", selector);
        return;
      }
      paypal.Buttons({
        createSubscription: function (data, actions) {
          return actions.subscription.create({ plan_id: planId });
        },
        onApprove: async function (data) {
          if (!uid) {
            alert("‚ùå Cannot save subscription ‚Äî no user ID.");
            return;
          }
          const subId = data.subscriptionID;
          console.log("Approved (PayPal), subscriptionID:", subId);
          await saveSubscriptionID(uid, subId, "paypal");
          checkSubscription();
        }
      }).render(selector);
    }

    // TODO: replace with your real sandbox plan IDs
    renderPayPalButton('#paypal-button-container-1m', 'P-2MW634431J448221NNCJ7F5I');
    renderPayPalButton('#paypal-button-container-1y', 'P-2MW634431J448221NNCJ7F5I');
    renderPayPalButton('#paypal-button-container-6m', 'P-2MW634431J448221NNCJ7F5I');

    

    // On load (optional auto-check) 
    window.onload = () => {
      if (!uid) return;
      // checkSubscription();     // PayPal status
      // checkSubscriptionLS();   // Lemon Squeezy status
    };

    //Free plan 
    function activateFreePlan() { window.location.href = "connect.html"; }
    window.activateFreePlan = activateFreePlan;


    const LSBTN = document.getElementById("LEMONSQUEEZY-HREF");

LSBTN.addEventListener("click", () => {
  window.location.href = "lemonsqueezy.html";
});


*/





























  // ===== UI =====
  function selectPlan(card) {
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    // Optional: remember selection
  }
  window.selectPlan = selectPlan;

  // ===== ID & Flags =====
  const uid = localStorage.getItem("uid") || "demo-user"; // keep UID from LocalStorage (fallback demo)

  // ===== Firebase Init =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

  let _db;
  async function initFirebase() {
    if (_db) return _db;
    const res = await fetch("/firebase-config");
    const config = await res.json();
    const app = initializeApp(config);
    _db = getFirestore(app);
    return _db;
  }

  // ===== Helpers =====
  // Safely add calendar months (handles month-end overflow, e.g., Jan 31 + 1m -> Feb 29/28)
  function addMonths(date, months) {
    const d = new Date(date);
    const day = d.getDate();
    d.setMonth(d.getMonth() + months);
    if (d.getDate() < day) d.setDate(0);
    return d;
  }

  // ===== subscriptionID (Firestore ONLY, per provider) =====
  // provider: "paypal" | "lemonsqueezy"
  async function saveSubscriptionID(uid, subscriptionID, provider) {
    try {
      if (!uid) throw new Error("Missing uid");
      if (!subscriptionID) throw new Error("Missing subscriptionID");
      if (!["paypal", "lemonsqueezy"].includes(provider)) {
        throw new Error(`Invalid provider: ${provider}`);
      }
      const db = await initFirebase();
      const fieldName = provider === "paypal" ? "PPsubscriptionID" : "LSsubscriptionID";
      await setDoc(
        doc(db, "userSubscriptions", uid),
        { [fieldName]: subscriptionID, updatedAt: serverTimestamp() },
        { merge: true }
      );
      console.log(`‚úÖ ${fieldName} saved to Firestore: ${subscriptionID}`);
    } catch (e) {
      console.error("‚ùå Firestore save failed:", e);
    }
  }

  // Save period metadata (approvedAt & currentPeriodEnd) alongside plan info
  async function savePeriodMetaToFirestore(uid, { provider, planId, planMonths }) {
    const db = await initFirebase();
    const approvedAt = new Date();
    const currentPeriodEnd = addMonths(approvedAt, planMonths);

    await setDoc(
      doc(db, "userSubscriptions", uid),
      {
        provider,                 // "paypal"
        planId,                   // PayPal plan ID
        planMonths,               // 1, 6, 12...
        approvedAt,               // stored as Firestore Timestamp
        currentPeriodEnd,         // stored as Firestore Timestamp
        currentPeriodEndEpochMs: currentPeriodEnd.getTime(), // optional: easy client checks
        lastUpdated: serverTimestamp()
      },
      { merge: true }
    );
    console.log("üóìÔ∏è Saved billing period:", { approvedAt, currentPeriodEnd, planMonths });
  }

  // provider: "paypal" | "lemonsqueezy"
  async function loadSubscriptionID(uid, provider) {
    try {
      if (!uid) throw new Error("Missing uid");
      if (!["paypal", "lemonsqueezy"].includes(provider)) {
        throw new Error(`Invalid provider: ${provider}`);
      }
      const db = await initFirebase();
      const snap = await getDoc(doc(db, "userSubscriptions", uid));
      if (!snap.exists()) {
        console.log(`‚ö†Ô∏è No subscription doc for uid: ${uid}`);
        return null;
      }
      const fieldName = provider === "paypal" ? "PPsubscriptionID" : "LSsubscriptionID";
      const id = snap.data()?.[fieldName] || null;
      if (id) {
        console.log(`üì• ${fieldName} loaded from Firestore:`, id);
        return id;
      }
      const legacy = snap.data()?.subscriptionID;
      if (legacy) {
        console.log("üîé Legacy subscriptionID found (consider migrating):", legacy);
        return legacy;
      }
      return null;
    } catch (e) {
      console.error("‚ùå Firestore load failed:", e);
      return null;
    }
  }

  // ===== PayPal: Check status (server endpoint: /check-subscription) =====
  async function checkSubscription() {
    if (!uid) {
      console.log("‚ùå No user ID found");
      alert("No user ID found. Please log in.");
      return;
    }

    const subscriptionID = await loadSubscriptionID(uid, "paypal");
    if (!subscriptionID) {
      console.log("‚ùå No subscription found for this user");
    //  alert("No subscription found for this user.");
      return;
    }

    fetch(`/check-subscription?subscriptionID=${encodeURIComponent(subscriptionID)}`)
      .then(res => res.json())
      .then(data => {
        console.log("PayPal subscription status:", data.status);
        if (data.status === "ACTIVE") {
   //       alert("‚úÖ PayPal subscription is active");
        } else {
    //      alert("‚ùå PayPal subscription is not active");
        }
      })
      .catch(err => {
        console.error("PayPal check error:", err);
        alert("Error checking PayPal subscription.");
      });
  }
  window.checkSubscription = checkSubscription;

  // ===== PayPal Buttons =====
  // NOTE: Ensure the PayPal JS SDK with "subscriptions" is included in your HTML:
  function renderPayPalButton(selector, planId, planMonths) {
    if (typeof paypal === "undefined" || !paypal?.Buttons) {
      console.warn("‚ö†Ô∏è PayPal SDK not loaded; skipping render for", selector);
      return;
    }
    paypal.Buttons({
      createSubscription: function (data, actions) {
        return actions.subscription.create({ plan_id: planId });
      },
      onApprove: async function (data) {
        if (!uid) {
          alert("‚ùå Cannot save subscription ‚Äî no user ID.");
          return;
        }
        const subId = data.subscriptionID;
        console.log("Approved (PayPal), subscriptionID:", subId);

        // Save the subscription ID under provider=paypal
        await saveSubscriptionID(uid, subId, "paypal");

        // Save approvedAt + computed currentPeriodEnd
        await savePeriodMetaToFirestore(uid, {
          provider: "paypal",
          planId,
          planMonths
        });

        // Your existing post-approve check
        checkSubscription();
      }
    }).render(selector);
  }

  // TODO: replace with your real sandbox plan IDs
  renderPayPalButton('#paypal-button-container-1m', 'P-0JK81678NP2946820NCN2VEI', 1);
  renderPayPalButton('#paypal-button-container-6m', 'P-79H549746T130084HNCN2VSY', 6);


// fake test only 1 $
//  renderPayPalButton('#paypal-button-container-6m', 'P-3T973528KS5492806NCN5ABY', 6);

  renderPayPalButton('#paypal-button-container-1y', 'P-9WP73999W2079694SNCN2V7Q', 12);





  



  // ===== On load (optional auto-check) =====
  window.onload = () => {
    if (!uid) return;
    // checkSubscription();     // PayPal status
    // checkSubscriptionLS();   // Lemon Squeezy status (if you add it)
  };

  // ===== Free plan =====
  function activateFreePlan() { window.location.href = "connect.html"; }
  window.activateFreePlan = activateFreePlan;

  // ===== LemonSqueezy button -> navigate =====
  const LSBTN = document.getElementById("LEMONSQUEEZY-HREF_1m");
  if (LSBTN) {
    LSBTN.addEventListener("click", () => {
      window.location.href = "lemonsqueezy.html";
    });
  }



    const LSBTN_6m = document.getElementById("LEMONSQUEEZY-HREF_6m");
  if (LSBTN_6m) {
    LSBTN_6m.addEventListener("click", () => {
      window.location.href = "lemonsqueezy6m.html";
    });
  }


    const LSBTN_1y = document.getElementById("LEMONSQUEEZY-HREF_1y");
  if (LSBTN_1y) {
    LSBTN_1y.addEventListener("click", () => {
      window.location.href = "lemonsqueezy1year.html";
    });
  }


































/*
const ts = 1755005200; // example timestamp (seconds)
const endDate = new Date(ts.toString().length === 10 ? ts * 1000 : ts);
const formattedDate = endDate.toLocaleString('en-GB', {
  day: '2-digit',
  month: 'long',
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit',
  hour12: false,
  timeZoneName: 'short'
}).replace(',', ' at');

*/
// this code comapres ls and paypal enddates then keeps only one and write a date only without a clock
//document.getElementById('sub-end-date').textContent = (await loadSubscriptionEndDates(uid)).toDateString();






const BOOLEAN = (await checkpaypal() || await checklemonsqueezy());

//alert(BOOLEAN)
const statusEl = document.getElementById('sub-status');
statusEl.textContent = BOOLEAN ? "Active" : "Inactive";
statusEl.style.color = BOOLEAN ? "green" : "red";



const endDate = await loadSubscriptionEndDates(uid);
document.getElementById('sub-end-date').textContent = endDate 
  ? endDate.toDateString() 
  : "--";




/*
// ===== PayPal: Check status (server endpoint: /check-subscription) =====
async function checkpaypal() {
  if (!uid) {
    console.log("‚ùå No user ID found");
    alert("No user ID found. Please log in.");
    return false; // return a boolean
  }

  const subscriptionID = await loadSubscriptionID(uid, "paypal");
  if (!subscriptionID) {
    console.log("‚ùå No subscription found for this user");
    alert("No subscription found for this user.");
    return false; // return a boolean
  }

  try {
    const res = await fetch(`/check-subscription?subscriptionID=${encodeURIComponent(subscriptionID)}`);
    const data = await res.json();

    console.log("PayPal subscription status:", data.status);

    // consider both status and a possible boolean `active` flag from your API
    const isActive =
      (typeof data?.status === "string" && data.status.toUpperCase() === "ACTIVE") ||
      !!data?.active;

    localStorage.setItem(`isSubscribed_${uid}`, String(isActive));

    alert(isActive ? "‚úÖ PayPal subscription is active" : "‚ùå PayPal subscription is not active");
    return isActive; // <-- boolean
  } catch (err) {
    console.error("PayPal check error:", err);
    alert("Error checking PayPal subscription.");
    return false; // fail closed
  }
}












// ===== Check subscription (server endpoint: /api/ls/check-subscription) =====
async function checklemonsqueezy() {
  if (!uid) throw new Error("Login first");

  const db = await initFirebase();
  const snap = await getDoc(doc(db, "userSubscriptions", uid));
  const id = snap.exists() ? snap.data().LSsubscriptionID : null;
  if (!id) return false;

  const res = await fetch(`/api/ls/check-subscription?subscriptionID=${encodeURIComponent(id)}`);
  if (!res.ok) return false;

  const json = await res.json();

  // Prefer explicit boolean if provided
  if (typeof json?.active === "boolean") return json.active;

  // Fallback to status string
  const status = (json?.status || "").toString().toLowerCase();
  return status === "active";
}
*/



// ===== PayPal: Check status (server endpoint: /check-subscription) =====
async function checkpaypal() {
  if (!uid) {
    console.log("‚ùå No user ID found");
    alert("No user ID found. Please log in.");
    return false;
  }

  const subscriptionID = await loadSubscriptionID(uid, "paypal");
  if (!subscriptionID) {
    console.log("‚ùå No subscription found for this user");
  //  alert("No subscription found for this user.");
    return false;
  }

  try {
    const res = await fetch(`/check-subscription?subscriptionID=${encodeURIComponent(subscriptionID)}`);
    const data = await res.json();

    console.log("PayPal subscription status:", data.status);

    // consider both status and a possible boolean `active` flag from your API
    const isActive =
      (typeof data?.status === "string" && data.status.toUpperCase() === "ACTIVE") ||
      !!data?.active;


    if (isActive) {
      if (data.current_period_end) {
        const endDate = new Date(data.current_period_end);
        const formattedDate = endDate.toLocaleString(); // local time
  //      alert(`‚úÖ PayPal subscription is active\nEnds on: ${formattedDate}`);
      } else {
  //      alert("‚úÖ PayPal subscription is active\nEnd date not provided.");
      }
    } else {
  //    alert("‚ùå PayPal subscription is not active");
    }

    return isActive;
  } catch (err) {
    console.error("PayPal check error:", err);
    alert("Error checking PayPal subscription.");
    return false;
  }
}




// ===== Check subscription (server endpoint: /api/ls/check-subscription) =====
async function checklemonsqueezy() {
  if (!uid) {
    alert("No user ID found. Please log in.");
    return false;
  }

  const db = await initFirebase();
  const snap = await getDoc(doc(db, "userSubscriptions", uid));
  const id = snap.exists() ? snap.data().LSsubscriptionID : null;
  if (!id) {
//    alert("No LemonSqueezy subscription found for this user.");
    return false;
  }

  try {
    const res = await fetch(`/api/ls/check-subscription?subscriptionID=${encodeURIComponent(id)}`);
    if (!res.ok) {
      alert("Error checking LemonSqueezy subscription.");
      return false;
    }

    const json = await res.json();

    // Determine if active
    const isActive =
      (typeof json?.active === "boolean" && json.active) ||
      (json?.status || "").toString().toLowerCase() === "active";

    if (isActive) {
      if (json.current_period_end) {
        const endDate = new Date(json.current_period_end);
        const formattedDate = endDate.toLocaleString(); // Local time
//        alert(`‚úÖ LemonSqueezy subscription is active\nEnds on: ${formattedDate}`);
      } else {
//        alert("‚úÖ LemonSqueezy subscription is active\nEnd date not provided.");
      }
    } else {
//      alert("‚ùå LemonSqueezy subscription is not active");
    }

    return isActive;
  } catch (err) {
    console.error("LemonSqueezy check error:", err);
    alert("Error checking LemonSqueezy subscription.");
    return false;
  }
}






/*
async function loadSubscriptionEndDates(uid) {
  if (!uid) {
    alert("‚ùå No user ID found");
    return null;
  }


  try {
    const db = await initFirebase();
    const snap = await getDoc(doc(db, "userSubscriptions", uid));

    if (!snap.exists()) {
      alert("‚ùå No subscription document found for this UID");
      return null;
    }

    const data = snap.data();
    const lsEnd = data.LScurrentPeriodEnd || null;
    const ppEnd = data.currentPeriodEnd || null;

    alert(
      `üìÖ LemonSqueezy End Date: ${lsEnd || "Not found"}\n` +
      `üìÖ PayPal End Date: ${ppEnd || "Not found"}`
    );


   return { LScurrentPeriodEnd: lsEnd, currentPeriodEnd: ppEnd };

  } catch (err) {
    console.error("üî• Error loading subscription end dates:", err);
    alert("Error loading subscription end dates");
    return null;
  }
}
*/



async function loadSubscriptionEndDates(uid) {
  if (!uid) {
    alert("‚ùå No user ID found");
    return null;
  }

  try {
    const db = await initFirebase();
    const snap = await getDoc(doc(db, "userSubscriptions", uid));

    if (!snap.exists()) {
//      alert("‚ùå No subscription document found for this UID");
      return null;
    }

    const data = snap.data();
  //  const lsEnd = data.LScurrentPeriodEnd || null;
  //  const ppEnd = data.currentPeriodEnd || null;



const ppEnd = data.currentPeriodEnd ? data.currentPeriodEnd.toDate() : null;
const lsEnd = data.LScurrentPeriodEnd ? data.LScurrentPeriodEnd.toDate() : null;


/*
    alert(
      `üìÖ LemonSqueezy End Date: ${lsEnd  || "Not found"}\n` +
      `üìÖ PayPal End Date: ${ppEnd|| "Not found"}`
    );
*/




    // Rule:
    // If both null/undefined ‚Üí return null
    if (!lsEnd && !ppEnd) return null;

    // If only one exists ‚Üí return it
    if (lsEnd && !ppEnd) return lsEnd;
    if (ppEnd && !lsEnd) return ppEnd;

    // If both exist ‚Üí return the bigger number
return new Date(Math.max(lsEnd.getTime(), ppEnd.getTime()));

  } catch (err) {
    console.error("üî• Error loading subscription end dates:", err);
    alert("Error loading subscription end dates");
    return null;
  }
}






</script>









</body>
</html>





















