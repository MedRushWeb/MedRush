<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choose Your Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body { background: linear-gradient(to right, #f8fafc, #e0f2fe); color: #1e293b; }
    .navbar { background: #1d4ed8; color: white; padding: 16px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
    .navbar h2 { font-size: 24px; }
    .nav-links a { color: white; margin-left: 20px; text-decoration: none; font-weight: 500; }
    .nav-links a:hover { text-decoration: underline; }
    .container { max-width: 1200px; margin: 0px auto; padding: 10px; text-align: center; }
    .container h1 { font-size: 36px; margin-bottom: 40px; color: #0f172a; }
    .plans { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
    .plan-card { background: white; border-radius: 16px; padding: 30px; width: 270px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); transition: transform 0.4s ease, border 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
    .plan-card::before { content: ''; position: absolute; height: 100%; width: 6px; background: #3b82f6; left: 0; top: 0; transition: width 0.3s; }
    .plan-card.selected::before { width: 100%; background: linear-gradient(90deg, #2563eb, #3b82f6); z-index: -1; }
    .plan-card.selected { color: white; transform: scale(1.05); }
    .plan-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
    .plan-price { font-size: 20px; margin-bottom: 15px; color: #2563eb; }
    .plan-card.selected .plan-price, .plan-card.selected .plan-title { color: white; }
    .plan-features { list-style: none; margin-bottom: 20px; }
    .plan-features li { margin: 8px 0; }
    .highlight { border: 3px solid #f59e0b; background: linear-gradient(145deg, #fff7ed, #fffbeb); min-height: 520px; position: relative; z-index: 5; box-shadow: 0 12px 24px rgba(0,0,0,0.25); }
    .footer { margin-top: 0px; text-align: center; padding: 20px; background: #1e40af; color: white; }
    @media (max-width: 900px) { .plans { flex-direction: column; align-items: center; } }
    .highlight-wrapper { display: flex; flex-direction: column; align-items: center; margin-top: -80px; }
    .highlight-label { background: #f59e0b; color: white; font-weight: bold; padding: 6px 12px; border-radius: 999px; font-size: 20px; margin-bottom: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 999; }
  
  .plan-card-free-plan {background: white; border-radius: 16px; padding: 30px; width: 200px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); transition: transform 0.4s ease, border 0.3s ease; position: relative; overflow: hidden; cursor: pointer;}
   
  
  .free-btn {
    background-color: #007bff;       /* Bootstrap blue */
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 15px;
  }

  .free-btn:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
  }

  .free-btn:active {
    background-color: #004080;
    transform: translateY(0);
  }
  </style>


<script src="https://www.paypal.com/sdk/js?client-id=Aec0bitCbqqY4v0NrmeMSxfe86n95Jmy9QbLXiU2woFf4vnFxb4e3W0HJ-fBsFqUKNPkhrLLc1KAtts3&vault=true&intent=subscription"></script>



</head>
<body>

  <div class="navbar">
    <h2>DrWheezy</h2>
    <div class="nav-links">
      <a href="home.html">Home</a>
      <a href="#">Features</a>
      <a href="contact.html">Contact</a>
    </div>
  </div>

  <div class="container">
    <h1></h1>
    <div class="plans">


      <!-- Free Plan -->
<div class="plan-card-free-plan" onclick="selectPlan(this)">
  <div class="plan-title">Free Plan</div>
  <div class="plan-price">0$/month</div>
  <ul class="plan-features">
    <li>âœ” 4 exams only</li>
    <li>âœ˜ no reset option</li>
    <li>âœ˜ No customized exams per id </li>
    <li>âœ˜ No performance tracking</li>
  </ul>
  <button class="free-btn" onclick="activateFreePlan()"> Free plan</button>
</div>

      <!-- 1 Month -->
      <div class="plan-card" onclick="selectPlan(this)">
        <div class="plan-title">1 month</div>
        <div class="plan-price">20$/month</div>
        <ul class="plan-features">
          <li>âœ” 1 month only</li>
          <li>âœ” all questions accessible</li>
          <li>âœ” custom id questions accessible</li>
          <li>âœ” unlimited exams</li>
        </ul>
        <div id="paypal-button-container-1m"></div>

        <button id="ls-subscribe-1m">Subscribe (Lemon Squeezy 1M)</button>

        <a href="https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1" class="lemonsqueezy-button">Buy test</a>



          
      </div>



      <!-- Highlighted Plan -->
      <div class="highlight-wrapper">
        <div class="highlight-label">Our Most Subscribed Plan</div>
        <div class="plan-card highlight" onclick="selectPlan(this)">
          <div class="plan-title">1 year</div>
          <div class="plan-price">10$/month</div>
          <div class="plan-price">120$/year</div>
          <ul class="plan-features">
            <li>âœ” 1 year</li>
            <li>âœ” all questions accessible</li>
            <li>âœ” custom id questions accessible</li>
            <li>âœ” unlimited exams</li>
          </ul>
          <div id="paypal-button-container-1y"></div>
        </div>
      </div>

      <!-- 6 Months -->
      <div class="plan-card" onclick="selectPlan(this)">
        <div class="plan-title">6 months</div>
        <div class="plan-price">15$/month</div>
        <div class="plan-price">90$/6 months</div>
        <ul class="plan-features">
          <li>âœ” 6 months</li>
          <li>âœ” all questions accessible</li>
          <li>âœ” custom id questions accessible</li>
          <li>âœ” unlimited exams</li>
        </ul>
        <div id="paypal-button-container-6m"></div>
      </div>

    </div>
  </div>

  <div class="footer">&copy; 2025 DrWheezy. All rights reserved.</div>




<script type="module">

  /***** UI *****/
  function selectPlan(card) {
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
  }
  window.selectPlan = selectPlan;

  /***** ID & Flags *****/
  const uid = localStorage.getItem("uid"); // keep UID from LocalStorage

  /***** Firebase Init *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

  let _db;
  async function initFirebase() {
    if (_db) return _db;
    const res = await fetch("/firebase-config");
    const config = await res.json();
    const app = initializeApp(config);
    _db = getFirestore(app);
    return _db;
  }

  /***** subscriptionID (Firestore ONLY) *****/
  async function saveSubscriptionID(uid, subscriptionID) {
    try {
      const db = await initFirebase();
      await setDoc(
        doc(db, "userSubscriptions", uid),
        { subscriptionID, updatedAt: serverTimestamp() },
        { merge: true }
      );
      console.log("âœ… subscriptionID saved to Firestore");
    } catch (e) {
      console.error("âŒ Firestore save failed:", e);
    }
  }

  async function loadSubscriptionID(uid) {
    try {
      const db = await initFirebase();
      const snap = await getDoc(doc(db, "userSubscriptions", uid));
      if (snap.exists()) {
        const id = snap.data()?.subscriptionID;
        if (id) {
          console.log("ðŸ“¥ subscriptionID loaded from Firestore:", id);
          return id;
        }
      }
    } catch (e) {
      console.error("âŒ Firestore load failed:", e);
    }
    return null;
  }

  /***** PayPal: Check status (server endpoint: /check-subscription) *****/
  async function checkSubscription() {
    if (!uid) {
      console.log("âŒ No user ID found");
      alert("No user ID found. Please log in.");
      return;
    }

    const subscriptionID = await loadSubscriptionID(uid);
    if (!subscriptionID) {
      console.log("âŒ No subscription found for this user");
      alert("No subscription found for this user.");
      return;
    }

    fetch(`/check-subscription?subscriptionID=${subscriptionID}`)
      .then(res => res.json())
      .then(data => {
        console.log("PayPal subscription status:", data.status);
        if (data.status === "ACTIVE") {
          localStorage.setItem(`isSubscribed_${uid}`, "true");
          alert("âœ… PayPal subscription is active");
        } else {
          localStorage.setItem(`isSubscribed_${uid}`, "false");
          alert("âŒ PayPal subscription is not active");
        }
      })
      .catch(err => {
        console.error("PayPal check error:", err);
        alert("Error checking PayPal subscription.");
      });
  }

  /***** PayPal Buttons *****/
  function renderPayPalButton(selector, planId) {
    if (typeof paypal === "undefined" || !paypal?.Buttons) {
      console.warn("âš ï¸ PayPal SDK not loaded; skipping render for", selector);
      return;
    }
    paypal.Buttons({
      createSubscription: function (data, actions) {
        return actions.subscription.create({ plan_id: planId });
      },
      onApprove: async function (data) {
        if (!uid) {
          alert("âŒ Cannot save subscription â€” no user ID.");
          return;
        }
        const subId = data.subscriptionID;
        console.log("Approved (PayPal), subscriptionID:", subId);
        await saveSubscriptionID(uid, subId);
        checkSubscription();
      }
    }).render(selector);
  }

  // TODO: put your real sandbox plan IDs here (or keep one if all the same)
  renderPayPalButton('#paypal-button-container-1m', 'P-2MW634431J448221NNCJ7F5I');
  renderPayPalButton('#paypal-button-container-1y', 'P-2MW634431J448221NNCJ7F5I');
  renderPayPalButton('#paypal-button-container-6m', 'P-2MW634431J448221NNCJ7F5I');

  /***** Lemon Squeezy Safe Loader *****/
  async function loadLemonScript() {
    if (window.LemonSqueezy) return window.LemonSqueezy;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://app.lemonsqueezy.com/js/lemon.js';
      s.async = true;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
    // wait for global
    return new Promise((resolve, reject) => {
      let tries = 0;
      const iv = setInterval(() => {
        if (window.LemonSqueezy) { clearInterval(iv); resolve(window.LemonSqueezy); }
        if (++tries > 50) { clearInterval(iv); reject(new Error("LemonSqueezy failed to load")); }
      }, 100);
    });
  }
  async function ensureLemon() { return window.LemonSqueezy || await loadLemonScript(); }

  /***** Lemon Squeezy Checkout URLs (replace with your real ones) *****/
  const LS_CHECKOUT_1M = "https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1";
  const LS_CHECKOUT_1Y = "https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1";
  const LS_CHECKOUT_6M = "https://medrush.lemonsqueezy.com/buy/07d06c2d-c986-41f8-84e3-7e1c0653e3fd?embed=1";



  async function openLsCheckout(url) {
    const LS = await ensureLemon();
    LS.Open({ checkout: url });
  }

  // Resolve by order_id (server: /ls/resolve-subscription), save, then check
  async function finalizeLsSubscription(orderId) {
    if (!orderId) return;
    if (!uid) { alert("âŒ Cannot save subscription â€” no user ID."); return; }
    try {
      const res = await fetch(`/ls/resolve-subscription?order_id=${orderId}`);
      const json = await res.json();
      const subscriptionID = json.subscriptionID;
      if (!subscriptionID) {
        console.error("No subscriptionID returned from server", json);
        alert("Could not resolve subscription. Contact support.");
        return;
      }
      console.log("Resolved (LS) subscriptionID:", subscriptionID);
      await saveSubscriptionID(uid, subscriptionID);
      await checkSubscriptionLS(subscriptionID);
    } catch (e) {
      console.error("Finalize LS error:", e);
      alert("Error finalizing Lemon Squeezy subscription.");
    }
  }

  // Check LS status (server: /check-ls-subscription)
  async function checkSubscriptionLS(subscriptionIDFromEvent) {
    try {
      const subscriptionID = subscriptionIDFromEvent || await loadSubscriptionID(uid);
      if (!subscriptionID) {
        console.log("âŒ No LS subscription found for this user");
        alert("No LS subscription found for this user.");
        return;
      }
      const r = await fetch(`/check-ls-subscription?subscriptionID=${subscriptionID}`);
      const data = await r.json();
      const status = (data && data.status) || "unknown";
      console.log("LS subscription status:", status);

      if (status === "active") {
        localStorage.setItem(`isSubscribed_${uid}`, "true");
        alert("âœ… Lemon Squeezy subscription is active");
      } else {
        localStorage.setItem(`isSubscribed_${uid}`, "false");
        alert(`âŒ Lemon Squeezy subscription not active (status: ${status})`);
      }
    } catch (e) {
      console.error("LS check error:", e);
      alert("Error checking Lemon Squeezy subscription.");
    }
  }

  // Setup LS success handler (equivalent to PayPal onApprove)
  (async () => {
    try {
      const LS = await ensureLemon();
      LS.Setup({
        eventHandler: async (event) => {
          if (event.event === "Checkout.Success") {
            const orderId = event?.data?.id; // Order ID
            console.log("LS Checkout.Success, order_id:", orderId);
            await finalizeLsSubscription(orderId);
          }
        }
      });
    } catch (e) {
      console.warn("LS not initialized (loader error). If you don't use LS, ignore this.");
    }
  })();

  // Attach LS buttons (ensure these IDs exist in your HTML)
  const btn1m = document.getElementById("ls-subscribe-1m");
  const btn1y = document.getElementById("ls-subscribe-1y");
  const btn6m = document.getElementById("ls-subscribe-6m");
  if (btn1m) btn1m.addEventListener('click', () => openLsCheckout(LS_CHECKOUT_1M));
  if (btn1y) btn1y.addEventListener('click', () => openLsCheckout(LS_CHECKOUT_1Y));
  if (btn6m) btn6m.addEventListener('click', () => openLsCheckout(LS_CHECKOUT_6M));

  /***** On load *****/
  window.onload = () => {
    if (!uid) return;
    // Call whichever provider(s) you want to verify on load:
    // checkSubscription();     // PayPal status
    // checkSubscriptionLS();   // Lemon Squeezy status
  };

  /***** Free plan *****/
  function activateFreePlan() { window.location.href = "connect.html"; }
  window.activateFreePlan = activateFreePlan;
</script>









</body>
</html>


